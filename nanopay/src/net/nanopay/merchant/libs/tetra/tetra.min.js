!function(e,t){function n(e){return e||this.timeout||this.requestTimeout}function o(e){return e||this.delay||this.requestDelay}function r(e){return e||this.then}!function(e){function t(){}function n(e,t){return function(){e.apply(t,arguments)}}function o(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],a(e,this)}function r(e,t){for(;3===e._state;)e=e._value;return 0===e._state?void e._deferreds.push(t):(e._handled=!0,void f(function(){var n=1===e._state?t.onFulfilled:t.onRejected;if(null===n)return void(1===e._state?i:s)(t.promise,e._value);var o;try{o=n(e._value)}catch(r){return void s(t.promise,r)}i(t.promise,o)}))}function i(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var r=t.then;if(t instanceof o)return e._state=3,e._value=t,void c(e);if("function"==typeof r)return void a(n(r,t),e)}e._state=1,e._value=t,c(e)}catch(i){s(e,i)}}function s(e,t){e._state=2,e._value=t,c(e)}function c(e){2===e._state&&0===e._deferreds.length&&f(function(){e._handled||d(e._value)});for(var t=0,n=e._deferreds.length;t<n;t++)r(e,e._deferreds[t]);e._deferreds=null}function u(e,t,n){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=n}function a(e,t){var n=!1;try{e(function(e){n||(n=!0,i(t,e))},function(e){n||(n=!0,s(t,e))})}catch(o){if(n)return;n=!0,s(t,o)}}var l=setTimeout,f="function"==typeof setImmediate&&setImmediate||function(e){l(e,0)},d=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)};o.prototype["catch"]=function(e){return this.then(null,e)},o.prototype.then=function(e,n){var o=new this.constructor(t);return r(this,new u(e,n,o)),o},o.all=function(e){var t=Array.prototype.slice.call(e);return new o(function(e,n){function o(i,s){try{if(s&&("object"==typeof s||"function"==typeof s)){var c=s.then;if("function"==typeof c)return void c.call(s,function(e){o(i,e)},n)}t[i]=s,0===--r&&e(t)}catch(u){n(u)}}if(0===t.length)return e([]);for(var r=t.length,i=0;i<t.length;i++)o(i,t[i])})},o.resolve=function(e){return e&&"object"==typeof e&&e.constructor===o?e:new o(function(t){t(e)})},o.reject=function(e){return new o(function(t,n){n(e)})},o.race=function(e){return new o(function(t,n){for(var o=0,r=e.length;o<r;o++)e[o].then(t,n)})},o._setImmediateFn=function(e){f=e},o._setUnhandledRejectionFn=function(e){d=e},e.Promise=o}(this);var i,s,c,u,a,l;a={},a.URL="http://terminal.ingenico.com",a.SERVICE_URL=a.URL+"/service",a.WAAS_URL=a.URL+"/waas",a.DESKTOP_WAID="00000000",a.WP_VERSION=null,a.START_END={DISABLED:{SHORT:"SHORT",DISABLED:"DISABLED"},METHODS:{SE_START:{id:1},SE_CHECK_PREPARE:{id:2},SE_END:{id:3}}},u={parse:function(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&n.push(t+"="+e[t]);return encodeURI(n.join("&"))},ajax:function(e,t,n,o,r,i,s,c){var u=new XMLHttpRequest;u.open(e,t,s),"POST"!==e&&"PUT"!==e||(n=n&&("string"==typeof n?n:JSON.stringify(n))),u.onreadystatechange=function(){function e(){r&&r({msg:u.statusText||"XMLHttpRequest error status "+u.status,status:u.status,response:n})}function t(){o&&o(n)}var n;if(4===u.readyState)if(u.onreadystatechange=null,200===u.status||204===u.status){if(n=u&&u.responseText?JSON.parse(u.responseText):null,c&&"function"==typeof c)return void(c(n)?t():e());n&&n["return"]?e():t()}else n=u&&u.responseText?JSON.parse(u.responseText):null,e()},i&&(u.timeout=i),u.setRequestHeader("Content-type","application/x-www-form-urlencoded"),u.send(n)},post:function(e,t,n,o,r,i){this.ajax("POST",e,t,n,o,r,!0,i)},get:function(e,t,n,o){this.ajax("GET",e,null,t,n,o,!0)},del:function(e,t,n,o,r,i){this.ajax("DELETE",e,t,n,o,r,i)},put:function(e,t,n,o,r){this.ajax("PUT",e,t,n,o,r,!0)}},s=[],c={},l=null;var f=function(t){var n,o,r,c,l,f;return t=t||{},o={},f=!1,r=t.service,c=t.namespace,l=t.formats,n={conn_id:"",serviceName:r,connected:!1,promise:null,evtSource:null,handler:{resolve:null,reject:null,promise:null},requestDelay:t.requestDelay||i.requestDelay,requestTimeout:t.requestTimeout||i.requestTimeout,connect:function(e){return e=e||{},e.then=e.then||"both",this.doPromise(e,function(e,t,o){if(n.connected)return console.info("Already connected"),e();var i=function(t){return n.connected=!0,t&&t.conn_id!==-1&&(n.conn_id=t.conn_id),e(t)},s="";for(var f in l)s+="format_"+(c||"")+"."+f+"="+l[f]+"&";return u.get(a.SERVICE_URL+"/"+r+"?multi&"+s,i,t,o)}),this},disconnect:function(e){return e=e||{},e.then=e.then||"both",this.doPromise(e,function(t,o,i){if(n.connected){var s=function(e){return n.connected=!1,t(e)};return u.del(a.SERVICE_URL+"/"+r+"?conn_id="+n.conn_id,{},s,o,i,e.async!==!1)}return console.info("Not connected"),t()}),this},call:function(e,t){return t=t||{},t.then=t.then||"resolved",this.doPromise(t,function(o,s,l){if(n.connected){var d=(c?c+".":"")+e+"Request",h=(c?c+".":"")+e+"Response",v=t.data||{};t.hide&&(f=!0);var p=function(e){return f&&(f=!1,i.show()),o(e)},E=function(e){return f&&(f=!1,i.show()),s(e)};return u.post(a.SERVICE_URL+"/"+r+"?request="+d+"&response="+h+"&conn_id="+n.conn_id,v,p,E,l,t.expect)}return s({msg:"Not connected call"})}),this},doPromise:function(e,t){return i.doPromise.apply(this,[e,t])},reset:function(){return i.reset.call(this)},then:function(e,t){return i.then.call(this,e,t)},"catch":function(e){return i.then.call(this,null,e)},success:function(e){return i.then.call(this,e,null)},error:function(e){return i.then.call(this,null,e)},resolve:function(e){return i.resolve.call(this,e,n.handler)},reject:function(e){return i.reject.call(this,e,n.handler)},on:function(e,r,i){return e&&!e.match(/\./)&&"message"!==e&&(e=(c?c+".":"")+e),t=t||{},t.then=t.then||"resolved",this.doPromise(t,function(t,s,c){return n.evtSource?(i=i||n,o[e]={eventName:e,callback:r,context:i},n.evtSource.addEventListener(e,function(t){var n=JSON.parse(t.data);o[e].callback.call(i,n)},!1),t()):s()}),this},open:function(t){return t=t||{},t.then=t.then||"resolved",this.doPromise(t,function(t,o,i){return n.connected&&!n.evtSource?(n.evtSource=new e.EventSource(a.SERVICE_URL+"/"+r+"/sse?conn_id="+n.conn_id),n.evtSource.onerror=function(e){return o(e)},n.evtSource.onopen=function(e){return t(e)},t()):o({msg:"Not connected or event already opened"})}),this},close:function(e){return e=e||{},e.then=e.then||"resolved",n.evtSource?(this.doPromise(e,function(e,t,o){return n.evtSource?(n.off(),n.evtSource.close(),n.evtSource=null,e()):t({msg:"Event source not exist"})}),this):this},off:function(e,t,r){function i(e){n.evtSource.removeEventListener(e,t||o[e].callback,!1),delete o[e]}if(e&&!e.match(/\./)&&"message"!==e&&(e=(c?c+".":"")+e),!n.evtSource)return this;if(e)if("string"==typeof e)i(e);else if("object"==typeof e&&e instanceof Array)for(var s=0,u=e.length;s<u;s++){var a;a=e[s],i(a)}else for(var l in o){var a;a=o[l].eventName,a.match(e)&&i(a)}else for(var l in o){var a;a=o[l].eventName,i(a)}return this},destroy:function(){var e;this.disconnect().close({success:this.reset}),e=s.indexOf(this),s.splice(e,1)}}};i={version:"1.6.2",requestDelay:0,requestTimeout:0,handler:{resolve:null,reject:null,promise:null},setup:function(e,t){function n(e){e.requestDelay=i.requestDelay,e.requestTimeout=i.requestTimeout}var o="http://terminal.ingenico.com/setup";if(t&&"function"==typeof t){console.warn("Deprecated since 1.1.0");var r;"function"==typeof e?u.get(o,function(t){return n(t),e(t)}):"object"==typeof e&&(r=JSON.parse(JSON.stringify(e)),i.requestDelay=r.requestDelay||i.requestDelay,i.requestTimeout=r.requestTimeout||i.requestTimeout,delete r.requestDelay,delete r.requestTimeout,u.post(o,r,t))}else if(e=e||{},e.then=e.then||"both",e&&e.data){var s=JSON.parse(JSON.stringify(e.data));i.requestDelay=e.data.requestDelay||i.requestDelay,i.requestTimeout=e.data.requestTimeout||i.requestTimeout,delete s.requestDelay,delete s.requestTimeout,this.doPromise(e,function(e,t,n){return u.post(o,s,e,t,n)})}else this.doPromise(e,function(e,t,n){return u.get(o,e,t,n)});return this},service:function(e){for(var t,n=0,o=s.length;n<o;n++){var r;if(r=s[n],r.serviceName===e.service)return r}return e.service?(t=new f(e),s.push(t),t):new Error(".service property is missing")},disconnect:function(){for(var e=0,t=s.length;e<t;e++){var n;n=s[e],n.connected&&u.del(a.SERVICE_URL+"/"+n.serviceName,{},function(){},function(){},n.requestTimeout,!1)}return this},destroy:function(){for(var e=0,t=s.length;e<t;e++){var n;n=s[e],n.destroy()}return this},lookup:function(e,t){if(t&&"function"==typeof t)console.warn("Deprecated since 1.1.0"),e&&u.get(a.SERVICE_URL+"?interface="+e,t);else{var n=t||{};n.then=n.then||"both",this.doPromise(n,function(t,n,o){return u.get(a.SERVICE_URL+"?interface="+e,t,n,o)})}return this},hide:function(){console.log("INGENICO:WCE:hide")},show:function(){console.log("INGENICO:WCE:show")},hideWP:function(){console.log("INGENICO:WCE:hideWP")},showWP:function(){console.log("INGENICO:WCE:showWP")},weblet:{hide:function(){return console.log("INGENICO:WEBLET:hide"),this},show:function(){return console.log("INGENICO:WEBLET:show"),this},notify:function(e){e=e||{};var t=e.badge||"default",n=e.count||0,o=e.save||!1,r=e.id?":"+e.id:"";return console.log("INGENICO:NOTIFY:"+t+":"+n+":"+o+r),this},on:function(t,n,o){return"wakeup"===t&&i.createWakeupEvent(),o=o||this,c[t]={eventName:t,callback:n.bind(o),context:o},e.addEventListener(t,c[t].callback,!1),this},trigger:function(t,n){function o(t){var o;o=new CustomEvent(t,n),e.dispatchEvent(o)}if(n=n||{},t)if("string"==typeof t)o(t);else if("object"==typeof t&&t instanceof Array)for(var r=0,i=t.length;r<i;r++)o(t[r]);else for(var s in c){var u;u=c[s].eventName,u.match(t)&&o(u)}else for(var s in c){var u;u=c[s].eventName,o(u)}return this},off:function(t,n,o){function r(t){e.removeEventListener(t,n||c[t].callback,!1),delete c[t]}if(t)if("string"==typeof t)r(t);else if("object"==typeof t&&t instanceof Array)for(var i=0,s=t.length;i<s;i++)r(t[i]);else for(var u in c){var a;a=c[u].eventName,a.match(t)&&r(a)}else for(var u in c){var a;a=c[u].eventName,r(a)}return this}},waas:function(t,n){function o(){var n=function(e){this.connectionId=null,this.sendResponse=function(n,o,r,i,s,c){var l="";return"function"==typeof o&&(r=arguments[2],i=arguments[3],s=arguments[4],c=arguments[5]),"object"==typeof o&&o.connectionId&&a.WP_VERSION>=2.06&&(l="conn_id="+o.connectionId),this.connectionId&&a.WP_VERSION>=2.06&&(l="conn_id="+this.connectionId),u.post(a.WAAS_URL+"/"+t+"/"+e+"?"+l,n||{},r,i,s,c),this}};return{clients:[],sendEvent:function(e,t,n,o,r,i,s){var c="";return"function"==typeof n&&(o=arguments[2],r=arguments[3],i=arguments[4],s=arguments[5]),"object"==typeof n&&n.connectionId&&a.WP_VERSION>=2.06&&(c="conn_id="+n.connectionId),u.post(a.WAAS_URL+"/"+l+"."+e+"?"+c,t||{},o,r,i,s),this},on:function(e,t,n){return t&&"function"==typeof t&&(n=t,t={}),c.push({eventName:e,properties:t,callBack:n}),this},start:function(){if(!a.WP_VERSION)return setTimeout(function(){r.start()},250),this;var o,u;o="?";for(var f=0,d=c.length;f<d;f++){var h=c[f],v=h.properties,p=h.eventName;if(v.perms&&"object"==typeof v.perms&&v.perms instanceof Array&&(o+="perms_"+p+"="+v.perms.toString()+"&"),v.formats){var E=p[0].toUpperCase()+p.slice(1);for(var m in v.formats)o+="format_"+l+"."+E+m+"="+v.formats[m]+"&"}}a.WP_VERSION>=2.06&&(u="multi",o+=u),i=new e.EventSource(a.WAAS_URL+"/"+t+o),s=new e.EventSource(a.WAAS_URL+"?"+u),s.addEventListener("ingenico.webos.ServiceConnect",function(e){r.clients.push(e.id)}),s.addEventListener("ingenico.webos.ServiceDisconnect",function(e){r.clients.splice(r.clients.indexOf(e.id),1)});for(var f=0,d=c.length;f<d;f++){var h=c[f],g=new n(h.eventName);!function(e,t){"ingenico.webos.ServiceConnect"===t.eventName||"ingenico.webos.ServiceDisconnect"===t.eventName?(i.addEventListener(t.eventName,function(e){t.callBack.call(this,e)},!1),s.addEventListener(t.eventName,function(e){t.callBack.call(this,e)},!1)):i.addEventListener(t.eventName,function(n){var o=JSON.parse(n.data);e.connectionId=o.$wp_connId||o.id,t.callBack.call(e,n),e.connectionId=null},!1)}(g,h)}return this}}}var r,i,s,c,l;return l=t.replace(/\.\w+$/,""),n=n||{},c=[],r=new o(t)},doPromise:function(t,i){function s(){var r;return r=new e.Promise(function(s,u){e.setTimeout(function(){return i(function(e){c.handler.resolve=s,c.handler.reject=u,c.handler.promise=r,c.resolve(e,c.handler)},function(e){c.handler.resolve=s,c.handler.reject=u,c.handler.promise=r,c.reject(e,c.handler)},n.call(c,t.requestTimeout))},o.call(c,t.requestDelay))})}var c=this;if(!this.promise||t.promise)this.promise=s();else{var u=r.call(c,t.then);"resolved"===u?c.success(s):"rejected"===u?c.error(s):c.then(s,s)}return(t.error||t.success)&&c.then(t.success,t.error),this},then:function(e,t){var n=this;return e&&!t?n.promise=n.promise.then(function(t){return e.call(n,t,n.handler)}):e&&t?n.promise=n.promise.then(function(t){return e.call(n,t,n.handler)},function(e){return t.call(n,e,n.handler)}):n.promise=n.promise["catch"](function(e){return t.call(n,e,n.handler)}),this},"catch":function(e){return this.then(null,e),this},success:function(e){return this.then(e,null),this},error:function(e){return this.then(null,e),this},resolve:function(e){return this.handler.resolve.call(this,e,this.handler),this},reject:function(e){return this.handler.reject.call(this,e,this.handler),this},reset:function(){return this.promise=null,this},checkServices:function(e,t){function n(){s.shift(),u=0,r()}function o(){u++,setTimeout(r,t.delay)}function r(){s.length&&u<t["try"]?i.reset().lookup(s[0],{expect:function(e){return e&&e.length}}).then(n,o):u===t["try"]?l(s[0]):a()}var s,c,u,a,l;return t=t||{},t.delay=t.delay||1e3,t["try"]=t["try"]||20,t.then=t.then||"both",c=this,u=0,s=e.slice(0),c.doPromise({},function(e,t){a=e,l=t,r()})}},t.addEventListener("visibilitychange",function(){t.hidden?i.weblet.trigger("hide"):i.weblet.trigger("show")}),e.addEventListener("beforeunload",function(e){e.preventDefault(),i.weblet.trigger("close"),i.disconnect()}),i.createWakeupEvent=function(){return i.service({service:"local.desktopenv.inactivityHandler",namespace:"ingenico.desktopenv"}).reset().disconnect().close().connect().open().on("WakeupEvent",function(e){i.weblet.trigger("wakeup",e.cause)})},i.service({service:"local.WebOs.Service",namespace:"ingenico.webos"}).connect().call("GetWPVersion").success(function(e){a.WP_VERSION=parseFloat(e.version,10)}).disconnect(),i.header={showAll:function(){console.log("INGENICO:HEADER-LEDS:show:show")},hideAll:function(){console.log("INGENICO:HEADER-LEDS:hide:hide")},showLeds:function(){console.log("INGENICO:HEADER-LEDS::show")},hideLeds:function(){console.log("INGENICO:HEADER-LEDS::hide")},showBanner:function(){console.log("INGENICO:HEADER-LEDS:show:")},hideBanner:function(){console.log("INGENICO:HEADER-LEDS:hide:")}};var d={},h=null,v=function(e,t){function n(e,t,n){if(t.tag&&""!==t.tag)d[t.tag]&&d[t.tag][e]&&d[t.tag][e](d[t.tag]),n&&delete d[t.tag];else for(var o in d)d[o][e]&&d[o][e](d[o]),n&&delete d[o]}if("string"!=typeof e)return new Error("Title is required");t=t||{};var o={};return this.title=o.title=e,this.tag=o.tag=(t.tag||Math.random())+"",this.ing_buttons=o.ing_buttons=t.ing_buttons||!1,t.body&&(o.body=t.body),t.onshow&&(this.onshow=t.onshow),t.onclose&&(this.onclose=t.onclose),t.onshow&&(this.onclick=t.onclick),h?h.reset().call("Notification",{data:o}):h=i.service({service:"local.webapp."+a.DESKTOP_WAID,namespace:"ingenico.webos"}).reset().connect().open().on("ShowNotificationEvent",function(e){n("onshow",e)}).on("ClickNotificationEvent",function(e){n("onclick",e,!0)}).on("CloseNotificationEvent",function(e){n("onclose",e,!0)}).call("Notification",{data:o}),this.close=function(){h.reset().call("CloseNotification",{data:{tag:o.tag}}).then(function(){n("onclose",o,!0)})},d[o.tag]=this,this};e.Notification=v,i.printer={setDiffuseMode:function(){console.log("INGENICO:WCE:printerDithering:diffuse")},setOrderedMode:function(){console.log("INGENICO:WCE:printerDithering:ordered")},setThreshold:function(e){e=e||"",console.log("INGENICO:WCE:printerDithering:threshold:"+e)}},i.startEnd=function(e){function t(){var e;return e=this,e.enabled=u,o=i.waas("ingenico.transaction.StartEnd").on("stateSE",function(t){var n=JSON.parse(t.data).set_state;if("undefined"!=typeof n){var o;return c?(1===n?e.enable():e.disable(),o=0):o=-3000001,this.sendResponse({current_state:e.enabled,is_state_configurable:c,"return":o})}return this.sendResponse({current_state:e.enabled,is_state_configurable:c,"return":0})}).on("getSEImplementedMethods",function(t){var n;n={"return":1,supportedMethods:e.enabled||disabledMode!==a.START_END.DISABLED.DISABLED?r:[]},this.sendResponse(n)}).on("executeSE",{formats:{"Request.input":"tlv"}},function(t){var o,r,i,s,c;i=this,o=JSON.parse(t.data),r=n[o.serviceId],s=disabledMode===a.START_END.DISABLED.SHORT&&!e.enabled,c=o.input;for(var u=0,l=c.length;u<l;u++){var f=c[u];if("0x9F948927"===f.tag){s=1&Number(f.data);break}}e.sendResponse=function(e,t){i.sendResponse.call(i,{"return":1,output:e},{connectionId:o.$wp_connId},t)},r?r.call(this,o.input,{isShortMode:s}):this.sendResponse({},{connectionId:o.$wp_connId})}).start(),this}var n,o,r,s,c,u;return e=e||{},c=e.isStateConfigurable!==!1,u=e.isEnabled!==!1,disabledMode=a.START_END.DISABLED[e.disabledMode]||a.START_END.DISABLED.DISABLED,n={},r=[],t.prototype.disable=function(){c&&this.enabled&&(this.enabled=0,i.weblet.trigger("SE_DISABLED"))},t.prototype.enable=function(){c&&!this.enabled&&(this.enabled=1,i.weblet.trigger("SE_ENABLED"))},t.prototype.sendResponse=function(){},t.prototype.on=function(e,t,o){var i;return t&&"function"==typeof t&&(n[e]=t,t={}),o&&(n[e]=o),i={},i.id=a.START_END.METHODS[e].id,t&&t.priority&&(i.priority=t.priority),r.push(i),s},s=new t},i.system={run:function(e){var t=e.webApp?"WebApps/"+e.webApp:e.path;return i.service({service:"local.desktopenv.explorer",namespace:"ingenico.desktopenv"}).reset().connect().call("SelectIcon",{data:{entryUrl:t}}).disconnect()}},"object"==typeof module&&null!=module&&module.exports?module.exports=i:"function"==typeof define&&define.amd?define(function(){return i}):e.tetra=i}(window,document);