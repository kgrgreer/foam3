p({"class":"net.nanopay.invoice.AuthenticatedInvoiceDAOTest","id":"AuthenticatedInvoiceDAOTest"})
p({"class":"foam.nanos.test.Test","id":"Approval tests","code":"import foam.dao.*;\nimport foam.nanos.auth.User;\nimport foam.util.Auth;\n\nimport net.nanopay.account.Account;\nimport net.nanopay.bank.BankAccountStatus;\nimport net.nanopay.bank.CABankAccount;\nimport net.nanopay.invoice.model.Invoice;\nimport net.nanopay.invoice.model.InvoiceStatus;\nimport net.nanopay.invoice.model.PaymentStatus;\nimport net.nanopay.tx.model.Transaction;\nimport net.nanopay.admin.model.ComplianceStatus;\n\naccountDAO = (DAO) x.get(\"accountDAO\");\nbareUserDAO = (DAO) x.get(\"bareUserDAO\");\ninvoiceDAO = (DAO) x.get(\"invoiceDAO\");\ntransactionDAO = (DAO) x.get(\"transactionDAO\");\n\n////////////////////////////////////////////////////////////////////////////////////\n///////////////////////////////// SETUP ////////////////////////////////////////////\n////////////////////////////////////////////////////////////////////////////////////\n\n\nbareUserDAO.where(foam.mlang.MLang.EQ(User.EMAIL, \"employee1@example.com\")).removeAll();\nemployee1 = new User();\nemployee1.setEmail(\"employee1@example.com\");\nemployee1.setGroup(\"smeBusinessEmployee\");\nemployee1.setEmailVerified(true); // Required to send or receive money.\nemployee1.setCompliance(ComplianceStatus.PASSED);\nemployee1 = bareUserDAO.put(employee1);\nemployee1Context = Auth.sudo(x, employee1);\n\n\naccountDAO.where(foam.mlang.MLang.EQ(Account.NAME, \"Approval Tests employee 1 test account\")).removeAll();\nemployee1BankAccount = new CABankAccount();\nemployee1BankAccount.setName(\"Approval Tests employee 1 test account\");\nemployee1BankAccount.setDenomination(\"CAD\");\nemployee1BankAccount.setAccountNumber(\"12345678\");\nemployee1BankAccount.setInstitution(1);\nemployee1BankAccount.setBranchId(\"12345\");\nemployee1BankAccount.setStatus(BankAccountStatus.VERIFIED);\n\n// previously, there where no permissions in place to prevent unauthorized groups from setting bank account statuses\n// after adding bank account status permissions, this test would not work\n// this is because in the normal .put method, despite the bank account status being set to verified in the lines above\n// it goes through a cloning procedure in the permissionedPropertyDAO, where it checks if the employee1's group (sme) \n// has permissions to read/write bank account status, since they do not it would instead reset the status property to unverified\n// that is why we must use the override put_, in order to set the employee bank account using the global context permissions\nemployee1BankAccount = employee1.getAccounts(employee1Context).put_(x, employee1BankAccount);\n\n\nbareUserDAO.where(foam.mlang.MLang.EQ(User.EMAIL, \"employee2@example.com\")).removeAll();\nemployee2 = new User();\nemployee2.setEmail(\"employee2@example.com\");\nemployee2.setGroup(\"smeBusinessEmployee\");\nemployee2.setEmailVerified(true); // Required to send or receive money.\nemployee2.setCompliance(ComplianceStatus.PASSED);\nemployee2 = bareUserDAO.put(employee2);\nemployee2Context = Auth.sudo(x, employee2);\n\n\nbareUserDAO.where(foam.mlang.MLang.EQ(User.EMAIL, \"approver@example.com\")).removeAll();\napprover = new User();\napprover.setEmail(\"approver@example.com\");\napprover.setGroup(\"smeBusinessApprover\");\napprover.setEmailVerified(true); // Required to send or receive money.\napprover.setCompliance(ComplianceStatus.PASSED);\napprover = bareUserDAO.put(approver);\napproverContext = Auth.sudo(x, approver);\n\n\naccountDAO.where(foam.mlang.MLang.EQ(Account.NAME, \"Approval Tests approver test account\")).removeAll();\napproverBankAccount = new CABankAccount();\napproverBankAccount.setName(\"Approval Tests approver test account\");\napproverBankAccount.setDenomination(\"CAD\");\napproverBankAccount.setAccountNumber(\"87654321\");\napproverBankAccount.setInstitution(1);\napproverBankAccount.setBranchId(\"12345\");\napproverBankAccount.setStatus(BankAccountStatus.VERIFIED);\n\n// please see the same as above with the employee1BankAccount on why we use put_ instead of put\napproverBankAccount = approver.getAccounts(approverContext).put_(x, approverBankAccount);\n\n\n///////////////////////////////////////////////////////////////////////////////////////\n///////////////////////////////// TEST CODE ///////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////////////\n\n\ninvoice = new Invoice();\ninvoice.setAmount(1);\ninvoice.setPayerId(employee1.getId());\ninvoice.setPayeeId(employee2.getId());\ninvoice.setDestinationCurrency(\"CAD\");\ninvoice.setAccount(employee1BankAccount.getId());\ninvoice = invoiceDAO.inX(employee1Context).put(invoice);\ninvoiceStatusIsCorrect = invoice.getStatus() == InvoiceStatus.UNPAID;\npaymentStatusIsCorrect = invoice.getPaymentMethod() == PaymentStatus.NONE;\nif ( ! invoiceStatusIsCorrect ) {\nprint(\"DEBUG: Invoice status is \" + invoice.getStatus());\n}\nif ( ! paymentStatusIsCorrect ) {\nprint(\"DEBUG: Payment status is \" + invoice.getPaymentMethod());\n}\ntest(invoiceStatusIsCorrect && paymentStatusIsCorrect, \"When an employee creates an invoice, the invoice status is UNPAID and the payment status is NONE.\");\n\n\ntransaction = new Transaction();\ntransaction.setSourceAccount(invoice.getAccount());\ntransaction.setDestinationAccount(invoice.getDestinationAccount());\ntransaction.setPayerId(invoice.getPayerId());\ntransaction.setPayeeId(invoice.getPayeeId());\ntransaction.setAmount(invoice.getAmount());\ntransaction.setInvoiceId(invoice.getId());\nthrew = false;\nmessage = \"\";\ntry {\ntransactionDAO.inX(employee1Context).put(transaction);\ninvoice = invoiceDAO.inX(employee1Context).find(invoice.id);\ninvoiceStatusIsCorrect = invoice.getStatus() == InvoiceStatus.PENDING_APPROVAL;\npaymentStatusIsCorrect = invoice.getPaymentMethod() == PaymentStatus.PENDING_APPROVAL;\nif ( ! invoiceStatusIsCorrect ) {\nprint(\"DEBUG: Invoice status is \" + invoice.getStatus());\n}\nif ( ! paymentStatusIsCorrect ) {\nprint(\"DEBUG: Payment status is \" + invoice.getPaymentMethod());\n}\n} catch (Throwable t) {\nthrew = true;\nmessage = t.getMessage();\nprint(\"DEBUG: \" + message);\n}\ntest(! threw && invoiceStatusIsCorrect && paymentStatusIsCorrect, \"When an employee tries to pay an invoice the invoice is set to a PENDING_APPROVAL state.\");\n\n\ninvoice = new Invoice();\ninvoice.setAmount(1);\ninvoice.setPayerId(approver.getId());\ninvoice.setPayeeId(employee2.getId());\ninvoice.setDestinationCurrency(\"CAD\");\ninvoice.setAccount(approverBankAccount.getId());\ninvoice = invoiceDAO.inX(approverContext).put(invoice);\ntest(invoice.getStatus() == InvoiceStatus.UNPAID && invoice.getPaymentMethod() == PaymentStatus.NONE, \"When an approver creates an invoice, the invoice status is UNPAID and the payment status is NONE.\");\n\n\ntransaction = new Transaction();\ntransaction.setSourceAccount(invoice.getAccount());\ntransaction.setDestinationAccount(invoice.getDestinationAccount());\ntransaction.setPayerId(invoice.getPayerId());\ntransaction.setPayeeId(invoice.getPayeeId());\ntransaction.setAmount(invoice.getAmount());\ntransaction.setInvoiceId(invoice.getId());\nthrew = false;\nmessage = \"\";\ntry {\ntransactionDAO.inX(approverContext).put(transaction);\n} catch (Throwable t) {\nthrew = true;\nmessage = t.getMessage();\nprint(\"DEBUG: \" + message);\n}\ntest(! threw, \"When an approver tries to pay an invoice, it works as expected.\");\n"})
